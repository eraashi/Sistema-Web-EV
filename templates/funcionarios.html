{% extends "base.html" %}

{% block title %}Funcionários{% endblock %}

{% block header %}Funcionários{% endblock %}

{% block content %}
<div class="flex space-x-6 h-[calc(100vh-120px)]">
    <!-- Primeira Div: Busca de Funcionários -->
    <div class="border border-blue-400 rounded-lg p-6 bg-white" style="flex: 1; min-width: 0;">
        <h2 class="text-lg font-semibold mb-4">Buscar Funcionários</h2>
        <div class="space-y-4">
            <!-- Filtro: Nome -->
            <div>
                <label for="nome" class="block text-sm font-medium text-gray-700">Nome</label>
                <input
                    id="nome"
                    type="text"
                    placeholder="Digite o nome..."
                    class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
            </div>
            <!-- Filtro: Cargo -->
            <div>
                <label for="cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                <select id="cargo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="tudo">Tudo</option>
                    <option value="monitor">Monitor</option>
                    <option value="diretor">Diretor</option>
                    <option value="coordenador">Coordenador</option>
                </select>
            </div>
            <!-- Filtro: Polo -->
            <div>
                <label for="polo" class="block text-sm font-medium text-gray-700">Polo</label>
                <select id="polo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="tudo">Tudo</option>
                    <!-- Opções serão preenchidas dinamicamente via JavaScript -->
                </select>
            </div>
            <!-- Lista de Funcionários -->
            <div id="funcionarios-list" class="mt-4 max-h-[calc(100%-220px)] overflow-y-auto">
                <!-- Resultados serão preenchidos dinamicamente via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Segunda Div: Detalhes do Funcionário -->
    <div id="funcionario-details" class="border border-blue-400 rounded-lg p-6 bg-white relative" style="flex: 1; min-width: 0;">
        <h2 class="text-lg font-semibold mb-4">Detalhes do Funcionário</h2>
        <div id="funcionario-details-content">
            <p class="text-gray-500">Selecione um funcionário para visualizar os detalhes.</p>
        </div>
        <hr class="border-t border-blue-400 my-4" />
        <!-- Seção de Logs -->
        <div id="funcionario-logs" class="mt-4">
            <h3 class="text-md font-semibold mb-2">Log Recente do Funcionário</h3>
            <div id="logs-list" class="max-h-[200px] overflow-y-auto border border-gray-200 rounded-md p-2">
                <!-- Logs serão preenchidos dinamicamente via JavaScript -->
            </div>
        </div>
        <hr class="border-t border-blue-400 my-4" />
        <div id="funcionario-actions" class="mt-4 flex justify-center space-x-2"></div>
    </div>

    <!-- Terceira Div: Botão Criar Cadastro -->
    <div class="border border-blue-400 rounded-lg p-6 bg-white flex items-center justify-center" style="flex: 1; min-width: 0;">
        <button id="create-funcionario-button" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex items-center">
            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Criar Cadastro
        </button>
    </div>
</div>

<!-- Container para Toasts -->
<div id="custom-toast-container"></div>

<!-- Modal de Criação -->
<div id="create-funcionario-modal" class="modal">
    <div class="modal-content modal-content-narrow">
        <h2 class="modal-title">Criar Novo Funcionário</h2>
        <form id="create-funcionario-form">
            <div class="modal-fields">
                <div class="modal-field-with-icon flex items-center mb-4">
                    <i data-lucide="user" class="h-5 w-5 mr-2 icon-align"></i>
                    <div class="field-container">
                        <label for="create-nome" class="modal-label">Nome</label>
                        <input type="text" id="create-nome" name="nome" class="modal-input modal-input-narrow" placeholder="Digite o nome..." required>
                        <div class="tooltip" id="tooltip-nome"></div>
                    </div>
                </div>
                <div class="modal-field-with-icon flex items-center mb-4">
                    <i data-lucide="id-card" class="h-5 w-5 mr-2 icon-align"></i>
                    <div class="field-container">
                        <label for="create-cpf" class="modal-label">CPF</label>
                        <input type="text" id="create-cpf" name="cpf" class="modal-input modal-input-narrow" placeholder="Digite o CPF..." required>
                        <div class="tooltip" id="tooltip-cpf"></div>
                    </div>
                </div>
                <div class="modal-field-with-icon flex items-center mb-4">
                    <i data-lucide="briefcase" class="h-5 w-5 mr-2 icon-align"></i>
                    <div class="field-container">
                        <label for="create-cargo" class="modal-label">Cargo</label>
                        <select id="create-cargo" name="cargo" class="modal-input modal-input-narrow" required>
                            <option value="" disabled selected hidden>Escolha um...</option>
                            <option value="monitor">Monitor</option>
                            <option value="diretor">Diretor</option>
                            <option value="coordenador">Coordenador</option>
                        </select>
                        <div class="tooltip" id="tooltip-cargo"></div>
                    </div>
                </div>
                <div class="modal-field-with-icon flex items-center mb-4">
                    <i data-lucide="school" class="h-5 w-5 mr-2 icon-align"></i>
                    <div class="field-container">
                        <label for="create-polo" class="modal-label">Polo</label>
                        <select id="create-polo" name="polo_name" class="modal-input modal-input-narrow" required>
                            <option value="" disabled selected hidden>Escolha um polo...</option>
                            <!-- Opções serão preenchidas dinamicamente via JavaScript -->
                        </select>
                        <div class="tooltip" id="tooltip-polo"></div>
                    </div>
                </div>
                <div class="modal-field-with-icon flex items-center mb-4">
                    <i data-lucide="building" class="h-5 w-5 mr-2 icon-align"></i>
                    <div class="field-container">
                        <label for="create-unidade" class="modal-label">Unidade</label>
                        <select id="create-unidade" name="unidade" class="modal-input modal-input-narrow">
                            <option value="" selected>Não especificado</option>
                            <!-- Opções serão preenchidas dinamicamente com base no polo -->
                        </select>
                        <div class="tooltip" id="tooltip-unidade"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancel-create-funcionario" class="modal-button modal-button-cancel">Cancelar</button>
                <button type="submit" class="modal-button modal-button-save">Salvar</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Estilo do Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fff;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
    border-radius: 8px;
    position: relative;
    top: 50%;
    transform: translateY(-50%);
}

.modal-content-narrow {
    width: 420px;
    max-width: 420px;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 20px;
}

.modal-fields {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.modal-field-with-icon {
    display: flex;
    flex-direction: row;
    align-items: center;
}

.field-container {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.modal-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
}

.modal-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 1rem;
    outline: none;
}

.modal-input-narrow {
    width: 350px;
}

.modal-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.icon-align {
    position: relative;
    top: 8px;
}

.modal-footer {
    margin-top: 24px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

.modal-button {
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
}

.modal-button-cancel {
    background-color: #d1d5db;
    color: #374151;
}

.modal-button-cancel:hover {
    background-color: #9ca3af;
}

.modal-button-save {
    background-color: #2563eb;
    color: #fff;
}

.modal-button-save:hover {
    background-color: #1d4ed8;
}

/* Estilo do Botão Excluir */
.delete-button {
    background-color: #dc2626;
    color: #fff;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
}

.delete-button:hover {
    background-color: #b91c1c;
}

/* Estilo do Tooltip */
.tooltip {
    position: absolute;
    top: 50%;
    left: -10px;
    transform: translateY(-50%);
    background-color: #ef4444;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    display: none;
    animation: fadeInOut 3s ease-in-out forwards;
}

/* Animação para o Tooltip */
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-50%) translateX(-10px); }
    10% { opacity: 1; transform: translateY(-50%) translateX(0); }
    90% { opacity: 1; transform: translateY(-50%) translateX(0); }
    100% { opacity: 0; transform: translateY(-50%) translateX(-10px); }
}

/* Toast Container */
#custom-toast-container {
    position: fixed !important;
    bottom: 16px !important;
    right: 16px !important;
    z-index: 10001 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
}

/* Toast Styles */
#custom-toast-container .custom-toast {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    min-width: 200px !important;
    padding: 6px 10px !important;
    border-radius: 6px !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    color: white !important;
    font-size: 13px !important;
    line-height: 1.2 !important;
}

#custom-toast-container .custom-toast-success {
    background-color: #22c55e !important;
    animation: fadeInOut 3s ease-in-out forwards !important;
}

#custom-toast-container .custom-toast-error {
    background-color: #ef4444 !important;
    animation: fadeInOut 3s ease-in-out forwards !important;
}

#custom-toast-container .custom-toast-warning {
    background-color: #f59e0b !important;
    animation: fadeInOut 5s ease-in-out forwards !important;
}

#custom-toast-container .custom-toast-icon {
    margin-right: 6px !important;
    flex-shrink: 0 !important;
}

#custom-toast-container .custom-toast-message {
    flex: 1 !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

#custom-toast-container .custom-toast-close {
    background: none !important;
    border: none !important;
    color: white !important;
    font-size: 16px !important;
    cursor: pointer !important;
    padding: 0 6px !important;
    flex-shrink: 0 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    let currentFuncionario = null;
    let isEditing = false;
    let polos = [];

    // Mapeamento de polos e suas unidades correspondentes
    const poloUnidadesMap = {
        "POLO I (Bacaxá)": [
            "E.M. ANÍZIA ROSA DE OLIVEIRA COUTINHO",
            "E.M. LUCIANA SANTANA COUTINHO",
            "E.M. RUBENS DE LIMA CAMPOS",
            "E.M. VALTEMIR JOSÉ DA COSTA",
            "E.M. JOÃO MACHADO DA CUNHA",
            "E.M. JARDIM IPITANGAS",
            "E.M. LÚCIO NUNES",
            "E.M. MANOEL MUNIZ DA SILVA",
            "E.M. MARGARIDA ROSA DE AMORIM",
            "E.M. ELCIRA DE OLIVEIRA COUTINHO",
            "E.M. BEATRIZ AMARAL",
            "C.M.E. MENALDO CARLOS DE MAGALHÃES",
            "C.M.E. PADRE MANUEL",
            "E.M. PROFESSOR FRANCISCO VIGNOLI",
            "E.M. PAULO LUIZ BARROSO OLIVEIRA",
            "E.M. PREFEITO WALQUIDES DE SOUZA LIMA",
            "E.M. VILATUR",
            "E.M. THEÓFILO DÁVILA"
        ],
        "POLO II (Sampaio Correia)": [
            "E.M. EDILSON VIGNOLI MARINS",
            "E.M. MARIA LUIZA DE AMORIM MENDONÇA",
            "E.M. JOÃO LAUREANO DA SILVA",
            "C.M.E. JURANDIR DA SILVA MELO",
            "E.M. SEBASTIÃO MANOEL DOS REIS",
            "E.M. VEREADOR IVAN DA SILVA MELO",
            "E.M. EDILÊNIO SILVA DE SOUZA"
        ],
        "POLO III (Jaconé)": [
            "E.M. ISMÊNIA DE BARROS BARROSO"
        ],
        "POLO IV (Saquarema)": [
            "E.M. ORGÉ FERREIRA DOS SANTOS",
            "C.M. GUSTAVO CAMPOS DA SILVEIRA",
            "E.M. JOSÉ BANDEIRA",
            "E.M. PROFESSORA OSÍRIS PALMIER DA VEIGA",
            "E.M. PROFESSORA MARIA DE LOURDES MELO PAES BARRETO",
            "E.M. BELINO CATHARINO DE SOUZA"
        ]
    };

    // Função para buscar os polos e preencher os selects
    async function loadPolos() {
        try {
            console.log('Fazendo requisição para /api/polos');
            const response = await fetch('/api/polos', { credentials: 'include' });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ao carregar polos: ${response.status} - ${errorText}`);
            }
            polos = await response.json();
            console.log('Polos recebidos da API:', polos);

            if (!Array.isArray(polos) || polos.length === 0) {
                console.warn('Nenhum polo retornado pela API');
                return;
            }

            const poloSelect = document.getElementById('polo');
            const createPoloSelect = document.getElementById('create-polo');

            // Limpar opções existentes (exceto as padrão)
            if (poloSelect) {
                poloSelect.innerHTML = '<option value="tudo">Tudo</option>';
            } else {
                console.error('Elemento com ID "polo" não encontrado no DOM');
            }

            if (createPoloSelect) {
                createPoloSelect.innerHTML = '<option value="" disabled selected hidden>Escolha um polo...</option>';
            } else {
                console.error('Elemento com ID "create-polo" não encontrado no DOM');
            }

            // Preencher os selects com os polos
            polos.forEach(polo => {
                console.log(`Adicionando polo: ${polo.nome}`);
                if (poloSelect) {
                    const option = document.createElement('option');
                    option.value = polo.nome;
                    option.textContent = polo.nome;
                    poloSelect.appendChild(option);
                }

                if (createPoloSelect) {
                    const createOption = document.createElement('option');
                    createOption.value = polo.nome;
                    createOption.textContent = polo.nome;
                    createPoloSelect.appendChild(createOption);
                }
            });

            console.log('Polos adicionados aos selects');
        } catch (error) {
            console.error('Erro ao carregar polos:', error);
            showToast('Erro ao carregar polos: ' + error.message, 'error', 'alert-circle', 3000);
        }
    }

    // Função para atualizar o select de unidades com base no polo selecionado
    function updateUnidadesSelect(poloNome, unidadeSelectId) {
        const unidadeSelect = document.getElementById(unidadeSelectId);
        if (!unidadeSelect) {
            console.error(`Elemento com ID "${unidadeSelectId}" não encontrado no DOM`);
            return;
        }

        unidadeSelect.innerHTML = '<option value="" selected>Não especificado</option>';

        const unidades = poloUnidadesMap[poloNome] || [];
        unidades.forEach(unidade => {
            const option = document.createElement('option');
            option.value = unidade;
            option.textContent = unidade;
            unidadeSelect.appendChild(option);
        });
    }

    // Função para buscar funcionários com base nos filtros
    async function searchFuncionarios() {
        const nome = document.getElementById('nome').value;
        const cargo = document.getElementById('cargo').value;
        const polo = document.getElementById('polo').value;

        try {
            const queryParams = new URLSearchParams();
            if (nome) queryParams.append('nome', nome);
            if (cargo !== 'tudo') queryParams.append('cargo', cargo);
            if (polo !== 'tudo') queryParams.append('polo', polo);

            const response = await fetch(`/api/funcionarios?${queryParams.toString()}`);
            let funcionarios = await response.json();

            // Ordenar por ordem alfabética (nome)
            funcionarios.sort((a, b) => a.nome.localeCompare(b.nome));

            // Limitar a 50 funcionários
            funcionarios = funcionarios.slice(0, 50);

            const funcionariosList = document.getElementById('funcionarios-list');
            funcionariosList.innerHTML = '';

            if (funcionarios.length === 0) {
                funcionariosList.innerHTML = '<p class="text-gray-500">Nenhum funcionário encontrado.</p>';
                return;
            }

            funcionarios.forEach(funcionario => {
                const div = document.createElement('div');
                div.className = 'p-2 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                div.textContent = `${funcionario.nome} (${funcionario.cargo}) - ${funcionario.polo_nome}`;
                div.dataset.id = funcionario.id;
                div.addEventListener('click', () => showFuncionarioDetails(funcionario.id));
                funcionariosList.appendChild(div);
            });
        } catch (error) {
            console.error('Erro ao buscar funcionários:', error);
            document.getElementById('funcionarios-list').innerHTML = '<p class="text-red-500">Erro ao buscar funcionários.</p>';
        }
    }

    // Função para exibir os detalhes de um funcionário
    async function showFuncionarioDetails(id) {
        try {
            const response = await fetch(`/api/funcionarios/${id}`);
            currentFuncionario = await response.json();
            currentFuncionario.id = id; // Armazenar o ID para usar na atualização
            isEditing = false;
            renderFuncionarioDetails();
        } catch (error) {
            console.error('Erro ao buscar detalhes do funcionário:', error);
            document.getElementById('funcionario-details-content').innerHTML = '<p class="text-red-500">Erro ao carregar detalhes do funcionário.</p>';
            document.getElementById('funcionario-actions').innerHTML = '';
            document.getElementById('logs-list').innerHTML = '';
        }
    }

    // Função para excluir um funcionário
    async function deleteFuncionario(id, nome) {
        // Primeira confirmação
        const confirmDelete = window.confirm(`Tem certeza que deseja excluir o cadastro de ${nome} do Banco de Dados?`);
        if (!confirmDelete) {
            console.log('Exclusão cancelada na primeira confirmação');
            return;
        }

        // Segunda confirmação
        const confirmIrreversible = window.confirm('Essa ação é irreversível, pretende continuar?');
        if (!confirmIrreversible) {
            console.log('Exclusão cancelada na segunda confirmação');
            return;
        }

        try {
            console.log(`Enviando requisição para excluir funcionário com ID: ${id}`);
            const response = await fetch(`/api/funcionarios/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ao excluir funcionário: ${errorText}`);
            }

            showToast('Funcionário excluído com sucesso!', 'success', 'check-circle', 3000);
            deselectFuncionario(); // Limpar os detalhes
            await searchFuncionarios(); // Atualizar a lista
        } catch (error) {
            console.error('Erro ao excluir funcionário:', error);
            showToast('Erro: ' + error.message, 'error', 'alert-circle', 3000);
        }
    }

    // Função para renderizar os detalhes do funcionário
    function renderFuncionarioDetails() {
        const detailsDiv = document.getElementById('funcionario-details-content');
        const actionsDiv = document.getElementById('funcionario-actions');
        const logsList = document.getElementById('logs-list');

        if (!currentFuncionario) {
            detailsDiv.innerHTML = '<p class="text-gray-500">Selecione um funcionário para visualizar os detalhes.</p>';
            actionsDiv.innerHTML = '';
            logsList.innerHTML = '';
            return;
        }

        if (isEditing) {
            // Atualizar o select de unidades com base no polo atual
            updateUnidadesSelect(currentFuncionario.polo_nome, 'edit-unidade');

            detailsDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Nome</p>
                            <input type="text" id="edit-nome" value="${currentFuncionario.nome}" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">CPF</p>
                            <input type="text" id="edit-cpf" value="${currentFuncionario.cpf}" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Cargo</p>
                            <select id="edit-cargo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="monitor" ${currentFuncionario.cargo.toLowerCase() === 'monitor' ? 'selected' : ''}>Monitor</option>
                                <option value="diretor" ${currentFuncionario.cargo.toLowerCase() === 'diretor' ? 'selected' : ''}>Diretor</option>
                                <option value="coordenador" ${currentFuncionario.cargo.toLowerCase() === 'coordenador' ? 'selected' : ''}>Coordenador</option>
                            </select>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Polo</p>
                            <select id="edit-polo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                ${polos.map(polo => `<option value="${polo.nome}" ${currentFuncionario.polo_nome === polo.nome ? 'selected' : ''}>${polo.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Unidade</p>
                            <select id="edit-unidade" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Opções preenchidas dinamicamente -->
                            </select>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Data de Inclusão</p>
                            <p class="text-gray-900">${currentFuncionario.created_at}</p>
                        </div>
                    </div>
                </div>
            `;
            actionsDiv.innerHTML = `
                <button id="cancel-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Cancelar</button>
                <button id="save-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Salvar</button>
            `;
            document.getElementById('cancel-btn').addEventListener('click', cancelEdit);
            document.getElementById('save-btn').addEventListener('click', saveEdit);

            // Adicionar evento para atualizar unidades ao mudar o polo no modo de edição
            const editPoloSelect = document.getElementById('edit-polo');
            if (editPoloSelect) {
                editPoloSelect.addEventListener('change', () => {
                    const selectedPolo = editPoloSelect.value;
                    const unidadeSelect = document.getElementById('edit-unidade');
                    const currentUnidade = unidadeSelect.value;

                    updateUnidadesSelect(selectedPolo, 'edit-unidade');

                    // Verificar se a unidade selecionada pertence ao novo polo
                    const unidadesDoPolo = poloUnidadesMap[selectedPolo] || [];
                    if (currentUnidade && !unidadesDoPolo.includes(currentUnidade)) {
                        unidadeSelect.value = ''; // Limpar o campo unidade
                    }
                });
            }

            // Limpar a lista de logs durante o modo de edição
            logsList.innerHTML = '';
        } else {
            detailsDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Nome</p>
                            <p class="text-gray-900">${currentFuncionario.nome}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">CPF</p>
                            <p class="text-gray-900">${currentFuncionario.cpf}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Cargo</p>
                            <p class="text-gray-900">${currentFuncionario.cargo}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Polo</p>
                            <p class="text-gray-900">${currentFuncionario.polo_nome}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Unidade</p>
                            <p class="text-gray-900">${currentFuncionario.unidade || 'Não especificado'}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Data de Inclusão</p>
                            <p class="text-gray-900">${currentFuncionario.created_at || 'Não especificado'}</p>
                        </div>
                    </div>
                </div>
            `;
            actionsDiv.innerHTML = `
                <button id="deselect-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <button id="edit-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Editar</button>
                <button id="delete-btn" class="delete-button">Excluir</button>
            `;
            document.getElementById('edit-btn').addEventListener('click', startEdit);
            document.getElementById('deselect-btn').addEventListener('click', deselectFuncionario);
            document.getElementById('delete-btn').addEventListener('click', () => {
                deleteFuncionario(currentFuncionario.id, currentFuncionario.nome);
            });

            // Renderizar a lista de logs
            if (currentFuncionario.logs && currentFuncionario.logs.length > 0) {
                logsList.innerHTML = currentFuncionario.logs.map(log => `
                    <div class="p-2 border-b border-gray-200">
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">${log.action_type} ${log.entity_type}</span> - 
                            ${log.created_at} - 
                            ${JSON.stringify(log.details)}
                        </p>
                    </div>
                `).join('');
            } else {
                logsList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum log recente encontrado.</p>';
            }
        }
    }

    // Função para iniciar o modo de edição
    function startEdit() {
        isEditing = true;
        renderFuncionarioDetails();
    }

    // Função para cancelar a edição
    function cancelEdit() {
        isEditing = false;
        renderFuncionarioDetails();
    }

    // Função para salvar as alterações
    async function saveEdit() {
        const updatedFuncionario = {
            nome: document.getElementById('edit-nome').value,
            cpf: document.getElementById('edit-cpf').value,
            cargo: document.getElementById('edit-cargo').value,
            polo_name: document.getElementById('edit-polo').value,
            unidade: document.getElementById('edit-unidade').value || null
        };

        try {
            const response = await fetch(`/api/funcionarios/${currentFuncionario.id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedFuncionario)
            });

            if (!response.ok) {
                throw new Error('Erro ao atualizar funcionário');
            }

            // Atualizar os dados locais com os valores editados
            currentFuncionario.nome = updatedFuncionario.nome;
            currentFuncionario.cpf = updatedFuncionario.cpf;
            currentFuncionario.cargo = updatedFuncionario.cargo.charAt(0).toUpperCase() + updatedFuncionario.cargo.slice(1);
            currentFuncionario.polo_nome = updatedFuncionario.polo_name;
            currentFuncionario.unidade = updatedFuncionario.unidade;

            isEditing = false;
            renderFuncionarioDetails();

            // Atualizar a lista de funcionários para refletir as mudanças
            await searchFuncionarios();
        } catch (error) {
            console.error('Erro ao salvar alterações:', error);
            showToast('Erro: ' + error.message, 'error', 'alert-circle', 3000);
        }
    }

    // Função para deselecionar o funcionário
    function deselectFuncionario() {
        currentFuncionario = null;
        isEditing = false;
        renderFuncionarioDetails();
    }

    // Função para abrir o modal de criação
    function openCreateModal() {
        const modal = document.getElementById('create-funcionario-modal');
        if (!modal) {
            console.error('Modal de criação não encontrado');
            return;
        }
        console.log('Abrindo modal de criação');
        modal.style.display = 'block';

        // Limpar o formulário e os tooltips
        document.getElementById('create-funcionario-form').reset();
        document.querySelectorAll('.tooltip').forEach(tooltip => {
            tooltip.style.display = 'none';
        });

        // Limpar e preencher o select de unidades com base no polo padrão (nenhum selecionado inicialmente)
        updateUnidadesSelect('', 'create-unidade');

        lucide.createIcons();
    }

    // Função para fechar o modal de criação
    function closeCreateModal() {
        const modal = document.getElementById('create-funcionario-modal');
        if (!modal) {
            console.error('Modal de criação não encontrado');
            return;
        }
        console.log('Fechando modal de criação');
        modal.style.display = 'none';
    }

    // Função para criar um novo funcionário
    async function createFuncionario(event) {
        event.preventDefault();
        console.log('Evento de submissão disparado para createFuncionario');

        const form = document.getElementById('create-funcionario-form');
        if (!form) {
            console.error('Formulário create-funcionario-form não encontrado');
            return;
        }

        const formData = new FormData(form);
        const funcionarioData = Object.fromEntries(formData);
        console.log('Dados do formulário:', funcionarioData);

        // Validação dos campos
        let hasError = false;
        const fields = [
            { id: 'nome', message: 'Por favor, insira o nome do funcionário' },
            { id: 'cpf', message: 'Por favor, insira o CPF do funcionário' },
            { id: 'cargo', message: 'Por favor, selecione o cargo' },
            { id: 'polo_name', message: 'Por favor, selecione o polo' }
        ];

        fields.forEach(field => {
            const value = funcionarioData[field.id];
            console.log(`Validando campo ${field.id}: Valor = "${value}"`);
            if (!value || value.trim() === '') {
                showTooltip(field.id, field.message);
                hasError = true;
            }
        });

        if (hasError) {
            console.log('Validação falhou: Campos obrigatórios não preenchidos');
            return;
        }

        console.log('Validação bem-sucedida, prosseguindo com a criação do funcionário');

        try {
            console.log('Enviando requisição para criar o funcionário...');
            const createResponse = await fetch('/api/funcionarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(funcionarioData),
                credentials: 'include'
            });

            if (!createResponse.ok) {
                const errorText = await createResponse.text();
                console.error('Erro na resposta do servidor:', errorText);
                throw new Error(`Erro ao criar funcionário: ${errorText}`);
            }

            const responseData = await createResponse.json();
            console.log('Funcionário criado com sucesso:', responseData);

            // Exibir toast de confirmação
            showToast('Funcionário criado com sucesso!', 'success', 'check-circle', 3000);

            // Fechar o modal e recarregar os funcionários
            closeCreateModal();
            await searchFuncionarios();
        } catch (error) {
            console.error('Erro ao criar funcionário:', error.message);
            showToast('Erro: ' + error.message, 'error', 'alert-circle', 3000);
        }
    }

    // Função para exibir toasts
    function showToast(message, type, icon, duration = 3000) {
        const toastContainer = document.getElementById('custom-toast-container');
        if (!toastContainer) {
            console.error('Toast container não encontrado');
            return;
        }

        const toastDiv = document.createElement('div');
        toastDiv.className = `custom-toast custom-toast-${type}`;
        toastDiv.innerHTML = `
            <i data-lucide="${icon}" class="custom-toast-icon h-3 w-3"></i>
            <span class="custom-toast-message">${message}</span>
            <button class="custom-toast-close">×</button>
        `;

        toastContainer.appendChild(toastDiv);

        lucide.createIcons();

        const timeout = setTimeout(() => {
            toastDiv.remove();
        }, duration);

        const closeButton = toastDiv.querySelector('.custom-toast-close');
        closeButton.addEventListener('click', () => {
            clearTimeout(timeout);
            toastDiv.remove();
        });
    }

    // Função para exibir tooltip
    function showTooltip(elementId, message) {
        console.log(`Exibindo tooltip para ${elementId}: ${message}`);
        const tooltip = document.getElementById(`tooltip-${elementId}`);
        if (tooltip) {
            tooltip.textContent = message;
            tooltip.style.display = 'block';
        } else {
            console.error(`Tooltip element tooltip-${elementId} not found`);
        }
    }

    // Carregar os polos ao iniciar a página
    await loadPolos();

    // Adicionar eventos de busca nos filtros
    document.getElementById('nome').addEventListener('input', searchFuncionarios);
    document.getElementById('cargo').addEventListener('change', searchFuncionarios);
    document.getElementById('polo').addEventListener('change', searchFuncionarios);

    // Adicionar event listener para o botão "Criar Cadastro"
    const createFuncionarioButton = document.getElementById('create-funcionario-button');
    if (createFuncionarioButton) {
        createFuncionarioButton.addEventListener('click', () => {
            console.log('Botão "Criar Cadastro" clicado');
            openCreateModal();
        });
    }

    // Adicionar event listener para fechar o modal ao clicar fora
    const createModal = document.getElementById('create-funcionario-modal');
    if (createModal) {
        createModal.addEventListener('click', (event) => {
            if (event.target === createModal) {
                console.log('Clique fora do modal de criação detectado');
                closeCreateModal();
            }
        });
    }

    // Adicionar event listener para o botão "Cancelar" do modal de criação
    const cancelCreateButton = document.getElementById('cancel-create-funcionario');
    if (cancelCreateButton) {
        cancelCreateButton.addEventListener('click', () => {
            console.log('Botão "Cancelar" do modal de criação clicado');
            closeCreateModal();
        });
    }

    // Adicionar event listener para o formulário de criação
    const createFuncionarioForm = document.getElementById('create-funcionario-form');
    if (createFuncionarioForm) {
        createFuncionarioForm.addEventListener('submit', createFuncionario);
    }

    // Adicionar evento para atualizar unidades ao mudar o polo no modal de criação
    const createPoloSelect = document.getElementById('create-polo');
    if (createPoloSelect) {
        createPoloSelect.addEventListener('change', () => {
            const selectedPolo = createPoloSelect.value;
            const unidadeSelect = document.getElementById('create-unidade');
            const currentUnidade = unidadeSelect.value;

            updateUnidadesSelect(selectedPolo, 'create-unidade');

            // Verificar se a unidade selecionada pertence ao novo polo
            const unidadesDoPolo = poloUnidadesMap[selectedPolo] || [];
            if (currentUnidade && !unidadesDoPolo.includes(currentUnidade)) {
                unidadeSelect.value = ''; // Limpar o campo unidade
            }
        });
    }

    // Buscar funcionários inicialmente
    searchFuncionarios();
});
</script>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
{% endblock %}